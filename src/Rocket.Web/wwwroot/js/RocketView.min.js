(function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports"],n)})(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function n(){this.id=0;this.color="yellow";this.rotation=0;this.speed=0;this.x=0;this.y=0;this.time=0;this.animation=null;this.animationTiming=0;this.shotUpdateFrequency=0;this.fire1=!1;this.fire2=!1;this.top=!1;this.bottom=!1;this.left=!1;this.right=!1}return n}();t.Player=i}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports"],n)}(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function n(){}return n.add="add",n.delete="delete",n.self="self",n}();t.PlayerMetadataAction=i}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports","./Player"],n)}(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n("./Player"),r=function(){function n(){this.id=0;this.color="yellow";this.player=new i.Player}return n}();t.PlayerMetadata=r}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports"],n)}(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function n(){}return n}();t.Point=i}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports"],n)}(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function n(){}return n}();t.CanvasTouch=i}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports"],n)}(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function n(){}return n.F12=123,n.KeyA=65,n.KeyW=87,n.KeyS=83,n.KeyD=68,n.LeftArrow=37,n.UpArrow=38,n.DownArrow=40,n.RightArrow=39,n.Space=32,n.KeyE=69,n}();t.KeyCodes=i}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports"],n)}(function(n,t){"use strict";var i,r,u,f,e;Object.defineProperty(t,"__esModule",{value:!0});i=function(){function n(){}return n.rocketWidth=15,n.rocketHeight=10,n.rocketIcon=10,n.shotWidth=5,n.shotHeight=2,n}();t.WorldConstants=i;r=function(){function n(){}return n.SendUpdateFrequency=50,n}();t.NetworkConstants=r;u=function(){function n(){}return n.AccelerationRate=100,n.DeAccelerationRate=200,n.BrakeRate=5,n.TurnRate=4,n.MaxSpeedPerSecond=500,n}();t.MovementConstants=u;f=function(){function n(){}return n.SpeedPerSecond=1e3,n.ShotDuration=1,n}();t.ShootingConstants=f;e=function(){function n(){}return n.ScreenUpdateFrequency=0,n.ExplosionAnimationName="explosion",n.ExplosionAnimationDuration=100,n}();t.AnimationConstants=e}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports"],n)}(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function n(){this.id=0;this.parent=0;this.type="basic";this.time=0;this.rotation=0;this.speed=0;this.x=0;this.y=0}return n}();t.Shot=i}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports","../lib/signalr/signalr"],n)}(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n("../lib/signalr/signalr"),r=function(){function n(n){this.isConnected=!1;this.networkUpdate=n}return n.prototype.connect=function(){var t=new i.ConsoleLogger(i.LogLevel.Information),r=i.TransportType.WebSockets,n="GameHub";console.log("http://"+document.location.host+"/"+n);this.connection=new i.HubConnection(n,{transport:r,logger:t});this.connection.on("PlayerMetadataUpdate",this.receivedPlayerMetadataUpdate.bind(this));this.connection.on("Update",this.receivedPlayerUpdate.bind(this));this.connection.on("Fire",this.receivedShot.bind(this));this.connection.onclose(this.closed);this.connection.start().then(this.started.bind(this)).catch(this.startFailed.bind(this))},n.prototype.started=function(){this.isConnected=!0;console.log("Connected")},n.prototype.startFailed=function(n){console.log(n)},n.prototype.closed=function(n){this.isConnected=!1;n?console.log("Connection closed due to error: "+n):console.log("Connection closed due to disconnect.")},n.prototype.sendPlayer=function(n){this.isConnected&&this.connection.invoke("Update",n)},n.prototype.receivedPlayerMetadataUpdate=function(n,t){this.networkUpdate.playerMetadataUpdateCommand(n,t)},n.prototype.receivedPlayerUpdate=function(n){this.networkUpdate.playerUpdateCommand(n)},n.prototype.receivedShot=function(n){this.networkUpdate.fireCommand(n)},n}();t.Communication=r}),function(n){if(typeof module=="object"&&typeof module.exports=="object"){var t=n(require,exports);t!==undefined&&(module.exports=t)}else typeof define=="function"&&define.amd&&define(["require","exports","./Point","./Player","./KeyCodes","./CanvasTouch","./PlayerMetadata","./PlayerMetadataAction","./Communication","./Constants"],n)}(function(n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var e=n("./Point"),o=n("./Player"),r=n("./KeyCodes"),u=n("./CanvasTouch"),s=n("./PlayerMetadata"),f=n("./PlayerMetadataAction"),h=n("./Communication"),i=n("./Constants"),c=function(){function n(){this.points=0;this.xSize=11;this.ySize=11;this.emptyScreenSpace=40;this.radius=5;this.rocketRotation=0;this.animationUpdate=0;this.sendUpdate=0;this.sendUpdatePlayer=new o.Player;this.leftTouchStart=null;this.leftTouchCurrent=null;this.rightTouchCurrent=null;this.keyboard=new Map;this.shots=new Map;this.debug=[];this.communication=new h.Communication(this)}return n.prototype.log=function(n){console.log(n);this.debug.push(n);this.debug.length>10&&this.debug.splice(0,1)},n.prototype.processFullscreenRequest=function(n,t){if(n>this.canvas.width*.9&&t<this.canvas.height*.1)if(document.webkitFullscreenEnabled){if(this.canvas.webkitRequestFullscreen){if(document.webkitFullscreenElement==null){this.log("canvas.webkitRequestFullscreen");try{this.canvas.webkitRequestFullscreen();this.log("canvas.webkitRequestFullscreen - OK!")}catch(i){this.log("Error: "+i);this.log(i)}}else document.webkitExitFullscreen();return}}else if(document.fullscreenEnabled&&this.canvas.requestFullscreen){document.fullscreenElement==null?this.canvas.requestFullscreen():document.exitFullscreen();return}},n.prototype.mousedown=function(n){(n.preventDefault(),this.processFullscreenRequest(n.clientX,n.clientY))||(n.clientX<this.canvas.width/2?(this.leftTouchStart=new u.CanvasTouch,this.leftTouchStart.id=0,this.leftTouchStart.x=n.screenX,this.leftTouchStart.y=n.screenY,this.leftTouchCurrent=null):(this.rightTouchCurrent=new u.CanvasTouch,this.rightTouchCurrent.id=0,this.rightTouchCurrent.x=n.screenX,this.rightTouchCurrent.y=n.screenY))},n.prototype.mouseup=function(n){n.preventDefault();this.leftTouchStart=null;this.leftTouchCurrent=null;this.rightTouchCurrent=null},n.prototype.mousemove=function(n){n.preventDefault();this.leftTouchStart&&(this.leftTouchCurrent=new u.CanvasTouch,this.leftTouchCurrent.id=0,this.leftTouchCurrent.x=n.screenX,this.leftTouchCurrent.y=n.screenY)},n.prototype.init=function(){var n=this,t=document.getElementById("canvas");t.width=window.innerWidth*.95;t.height=window.innerHeight*.95;window.addEventListener("resize",function(){console.log("resize");document.webkitFullscreenElement||document.fullscreenElement?(t.width=window.innerWidth,t.height=window.innerHeight):(t.width=window.innerWidth*.95,t.height=window.innerHeight*.95)});window.addEventListener("error",function(n){var t="Error: "+n.message+" at line "+n.lineno;console.log(t);alert(t)});document.addEventListener("keydown",function(t){n.keydown(t);t.keyCode!=r.KeyCodes.F12&&t.preventDefault()});document.addEventListener("keyup",function(t){n.keyup(t);t.keyCode!=r.KeyCodes.F12&&t.preventDefault()});this.canvas=t;this.context=this.canvas.getContext("2d");this.context.font="14pt Arial";this.canvas.addEventListener("touchstart",function(t){var r,i;for(t.preventDefault(),r=0;r<t.changedTouches.length;r++){if(i=t.changedTouches[r],n.processFullscreenRequest(i.clientX,i.clientY))return;i.clientX<n.canvas.width/2?(n.leftTouchStart={id:i.identifier,x:i.clientX,y:i.clientY},n.leftTouchCurrent=null):n.rightTouchCurrent={id:i.identifier,x:i.clientX,y:i.clientY}}},!1);this.canvas.addEventListener("touchend",function(t){var i,r;for(t.preventDefault(),i=0;i<t.changedTouches.length;i++)r=t.changedTouches[i],r.clientX<n.canvas.width/2?(n.leftTouchStart=null,n.leftTouchCurrent=null):n.rightTouchCurrent=null},!1);this.canvas.addEventListener("touchcancel",function(t){var i,r;for(t.preventDefault(),i=0;i<t.changedTouches.length;i++)r=t.changedTouches[i],r.clientX<n.canvas.width/2?(n.leftTouchStart=null,n.leftTouchCurrent=null):n.rightTouchCurrent=null},!1);this.canvas.addEventListener("touchmove",function(t){var r,i;for(t.preventDefault(),r=0;r<t.changedTouches.length;r++)i=t.changedTouches[r],n.leftTouchStart!=undefined&&n.leftTouchStart.id==i.identifier?(n.leftTouchCurrent=new u.CanvasTouch,n.leftTouchCurrent.id=i.identifier,n.leftTouchCurrent.x=i.clientX,n.leftTouchCurrent.y=i.clientY):n.rightTouchCurrent!=undefined&&n.rightTouchCurrent.id==i.identifier&&(n.rightTouchCurrent=new u.CanvasTouch,n.rightTouchCurrent.id=i.identifier,n.rightTouchCurrent.x=i.clientX,n.rightTouchCurrent.y=i.clientY)},!1);t.addEventListener("mousedown",function(t){return n.mousedown(t)});t.addEventListener("mousemove",function(t){return n.mousemove(t)});t.addEventListener("mouseup",function(t){return n.mouseup(t)});this.points=0;this.playerMetadata=new s.PlayerMetadata;this.playerMetadata.player.x=1e4;this.playerMetadata.player.y=1e4;this.playerMetadata.color="red";this.resetRocket();this.others=new Map;this.communication.connect();this.setPoints()},n.prototype.resetRocket=function(){this.playerMetadata.player.rotation=Math.PI*3/2;this.playerMetadata.player.speed=0},n.prototype.requestAnimationFrame=function(n){this.update(n);window.requestAnimationFrame(this.requestAnimationFrame.bind(this))},n.prototype.fixShotUndefinedProperties=function(n){n.rotation==undefined&&(n.rotation=0);n.speed==undefined&&(n.speed=0);n.time==undefined&&(n.time=0);n.type==undefined&&(n.type="");n.x==undefined&&(n.x=0);n.y==undefined&&(n.y=0)},n.prototype.fixPlayerUndefinedProperties=function(n){n.animation==undefined&&(n.animation=null);n.animationTiming==undefined&&(n.animationTiming=0);n.time==undefined&&(n.time=0);n.top==undefined&&(n.top=!1);n.bottom==undefined&&(n.bottom=!1);n.left==undefined&&(n.left=!1);n.right==undefined&&(n.right=!1);n.rotation==undefined&&(n.rotation=0);n.x==undefined&&(n.x=0);n.y==undefined&&(n.y=0);n.fire1==undefined&&(n.fire1=!1);n.fire2==undefined&&(n.fire2=!1);n.speed==undefined&&(n.speed=0)},n.prototype.fireCommand=function(n){this.fixShotUndefinedProperties(n);var t=this.shots.get(n.id);t!=null?t.time=n.time:this.shots.set(n.id,n)},n.prototype.playerUpdateCommand=function(n){var t;if(this.fixPlayerUndefinedProperties(n),n.id==this.playerMetadata.id){var i=this.playerMetadata.player.x-n.x,r=this.playerMetadata.player.y-n.y,u=Math.sqrt(i*i+r*r);u>0&&this.log("Player "+n.id+" distance from existing location "+u+".");this.playerMetadata.player=n}else t=this.others.get(n.id),t!=null&&(t.player=n)},n.prototype.playerMetadataUpdateCommand=function(n,t){this.log("Player metadata update: "+n+" - "+t.id);console.log(t);t.player!=undefined&&this.fixPlayerUndefinedProperties(t.player);n==f.PlayerMetadataAction.add?this.others.set(t.id,t):n==f.PlayerMetadataAction.delete?this.others.delete(t.id):n==f.PlayerMetadataAction.self&&(this.playerMetadata=t)},n.prototype.updatePlayer=function(n,t){n.animation!=null?(n.animationTiming-=t*i.AnimationConstants.ExplosionAnimationDuration,n.animationTiming<=0&&(n.rotation=Math.PI*3/2,n.speed=0,n.animation=null,n.animationTiming=0)):(n.left&&(n.rotation-=t*i.MovementConstants.TurnRate,n.rotation<0&&(n.rotation+=2*Math.PI)),n.right&&(n.rotation+=t*i.MovementConstants.TurnRate,n.rotation>2*Math.PI&&(n.rotation-=2*Math.PI)),n.top?(n.speed+=t*i.MovementConstants.AccelerationRate,n.speed>i.MovementConstants.MaxSpeedPerSecond&&(n.speed=i.MovementConstants.MaxSpeedPerSecond)):n.speed>0&&(n.speed-=t*i.MovementConstants.DeAccelerationRate,n.speed<1&&(n.speed=0)),n.bottom&&(n.speed-=t*i.MovementConstants.BrakeRate,n.speed<0&&(n.speed=0)),n.x+=t*n.speed*Math.cos(n.rotation),n.y+=t*n.speed*Math.sin(n.rotation))},n.prototype.fixAngle=function(n){return n<0?n+=2*Math.PI:n>2*Math.PI&&(n-=2*Math.PI),n},n.prototype.radToDegrees=function(n){return n*90/Math.PI*2},n.prototype.update=function(n){var l=this,t=(n-this.animationUpdate)/1e3,r,u,f,e,s,c;for(this.updatePlayer(this.playerMetadata.player,t),this.others.forEach(function(n){l.updatePlayer(n.player,t)}),this.processInput(),r=[],this.shots.forEach(function(n){n.x+=t*n.speed*Math.cos(n.rotation);n.y+=t*n.speed*Math.sin(n.rotation);n.time-=t;n.time<0&&r.push(n.id)}),u=0;u<r.length;u++)this.shots.delete(r[u]);f=!1;e=["left","right","top","bottom","fire1","fire2"];for(s in e){var o=e[s],a=this.sendUpdatePlayer[o],h=this.playerMetadata.player[o];a!=h&&(f=!0,this.sendUpdatePlayer[o]=h)}f&&(c=(n-this.sendUpdate)/1e3,this.sendUpdate=n,this.playerMetadata.player.time=n,this.communication.sendPlayer(this.playerMetadata.player),this.log("send: "+c+"s"));n>this.animationUpdate+i.AnimationConstants.ScreenUpdateFrequency&&(this.draw(),this.animationUpdate=n)},n.prototype.processInput=function(){if(this.playerMetadata.player.left=this.keyboard.has(r.KeyCodes.LeftArrow)||this.keyboard.has(r.KeyCodes.KeyA),this.playerMetadata.player.right=this.keyboard.has(r.KeyCodes.RightArrow)||this.keyboard.has(r.KeyCodes.KeyD),this.playerMetadata.player.top=this.keyboard.has(r.KeyCodes.UpArrow)||this.keyboard.has(r.KeyCodes.KeyW),this.playerMetadata.player.bottom=this.keyboard.has(r.KeyCodes.DownArrow)||this.keyboard.has(r.KeyCodes.KeyS),this.playerMetadata.player.fire1=this.keyboard.has(r.KeyCodes.Space)||this.rightTouchCurrent!=null,this.keyboard.has(r.KeyCodes.KeyE)&&(this.playerMetadata.player.animation=i.AnimationConstants.ExplosionAnimationName,this.playerMetadata.player.animationTiming=i.AnimationConstants.ExplosionAnimationDuration),this.leftTouchStart&&this.leftTouchCurrent){var t=this.leftTouchCurrent.x-this.leftTouchStart.x,u=this.leftTouchCurrent.y-this.leftTouchStart.y,n=Math.atan2(u,t);n=n<0?Math.PI*2+n:n;var s=this.playerMetadata.player.rotation,f=this.fixAngle(s-n),e=this.fixAngle(n-this.playerMetadata.player.rotation),o=Math.sqrt(t*t+u*u);Math.abs(e-f)<5.8&&(f>e?this.playerMetadata.player.right=!0:f<e&&(this.playerMetadata.player.left=!0));o<30?this.playerMetadata.player.bottom=!0:o>60&&(this.playerMetadata.player.top=!0)}},n.prototype.draw=function(){var f=this,r,u,n,s;this.context.save();this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var t=45,i=45,e=this.playerMetadata.player.x%t,o=this.playerMetadata.player.y%i;for(n=0;n<=this.canvas.width/t;n++)r=n*t,this.context.beginPath(),this.context.moveTo(r-e,0),this.context.lineTo(r-e,this.canvas.height),this.context.stroke();for(n=0;n<=this.canvas.height/i;n++)u=n*i,this.context.beginPath(),this.context.moveTo(0,u-o),this.context.lineTo(this.canvas.width,u-o),this.context.stroke();for(this.others.forEach(function(n){f.drawPlayer(n)}),this.drawPlayer(this.playerMetadata),this.shots.forEach(function(n){f.drawShot(n)}),this.context.strokeRect(this.canvas.width*.9,0,this.canvas.width*.1,this.canvas.height*.1),this.context.fillStyle="black",n=0;n<this.debug.length;n++)s=this.debug[n],this.context.fillText(s,40,n*20);this.context.restore()},n.prototype.drawShot=function(n){var u=n.x-this.playerMetadata.player.x,f=n.y-this.playerMetadata.player.y,t=u+this.canvas.width/2,r=f+this.canvas.height/2;Math.abs(u)<this.canvas.width/2&&Math.abs(f)<this.canvas.height/2&&(this.context.save(),this.context.translate(t,r),this.context.rotate(n.rotation),this.context.translate(-t,-r),this.context.fillStyle="purple",this.context.fillRect(t-i.WorldConstants.shotWidth,r-i.WorldConstants.shotHeight,i.WorldConstants.shotWidth*2,i.WorldConstants.shotHeight*2),this.context.restore())},n.prototype.drawPlayer=function(n){var t=n.player.x-this.playerMetadata.player.x,r=n.player.y-this.playerMetadata.player.y,u=t+this.canvas.width/2,f=r+this.canvas.height/2;if(Math.abs(t)<this.canvas.width/2&&Math.abs(r)<this.canvas.height/2)this.context.save(),this.context.translate(u,f),this.context.rotate(n.player.rotation),this.context.translate(-u,-f),n.player.animation!=null?(console.log("Anim: "+n.player.animation),this.context.beginPath(),this.context.fillStyle="yellow",this.context.arc(u,f,n.player.animationTiming,0,2*Math.PI),this.context.fill(),this.context.closePath()):(this.context.beginPath(),this.context.moveTo(u-i.WorldConstants.rocketWidth,f-i.WorldConstants.rocketHeight),this.context.lineTo(u+i.WorldConstants.rocketWidth,f),this.context.lineTo(u-i.WorldConstants.rocketWidth,f+i.WorldConstants.rocketHeight),this.context.lineTo(u-i.WorldConstants.rocketWidth,f-i.WorldConstants.rocketHeight),this.context.fillStyle=n.player.fire1?"blue":n.color,this.context.fill(),this.context.closePath()),this.context.restore();else{var e=this.playerMetadata.player.x-this.canvas.width/2,o=this.playerMetadata.player.y-this.canvas.height/2,s=this.playerMetadata.player.x+this.canvas.width/2,h=this.playerMetadata.player.y+this.canvas.height/2,c=this.calculateIntersection(this.playerMetadata.player.x,this.playerMetadata.player.y,n.player.x,n.player.y,e,o,s,o),l=this.calculateIntersection(this.playerMetadata.player.x,this.playerMetadata.player.y,n.player.x,n.player.y,e,h,s,h),a=this.calculateIntersection(this.playerMetadata.player.x,this.playerMetadata.player.y,n.player.x,n.player.y,e,o,e,h),v=this.calculateIntersection(this.playerMetadata.player.x,this.playerMetadata.player.y,n.player.x,n.player.y,s,o,s,h);this.context.fillStyle=n.player.fire1?"blue":n.color;c?(t=c.x-e,r=0):l?(t=l.x-e,r=this.canvas.height):a?(t=0,r=a.y-o):v&&(t=this.canvas.width,r=v.y-o);this.context.fillRect(t-i.WorldConstants.rocketIcon,r-i.WorldConstants.rocketIcon,i.WorldConstants.rocketIcon*2,i.WorldConstants.rocketIcon*2)}},n.prototype.calculateIntersection=function(n,t,i,r,u,f,o,s){var h=new e.Point;if(h.x=Math.floor(((n*r-t*i)*(u-o)-(n-i)*(u*s-f*o))/((n-i)*(f-s)-(t-r)*(u-o))),h.y=Math.floor(((n*r-t*i)*(f-s)-(t-r)*(u*s-f*o))/((n-i)*(f-s)-(t-r)*(u-o))),h.x&&h.y){var c=Math.min(n,i),l=Math.max(n,i),a=Math.min(t,r),v=Math.max(t,r);if(h.x>=c&&h.x<=l&&h.y>=a&&h.y<=v)return h}return null},n.prototype.keydown=function(n){this.keyboard.has(n.keyCode)||this.keyboard.set(n.keyCode,Date.now())},n.prototype.keyup=function(n){this.keyboard.delete(n.keyCode)},n.prototype.setPoints=function(){document.title="Rocket"},n}();t.RocketView=c});
//# sourceMappingURL=RocketView.min.js.map